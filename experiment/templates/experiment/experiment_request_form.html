{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %} {# این خط رو قبلا درست کردین، عالیه! #}

{% block head %}
{{ form.media }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.6.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
{% endblock %}

{% block title %}
{% if form.instance.pk %}
ویرایش درخواست آزمایش
{% else %}
ثبت درخواست آزمایش جدید
{% endif %}
{% endblock %}

{% block main %}
<div class="container">
    <div class="card shadow rounded-2">
                <div class="card-header">
            <h3 class="card-title">
                {% if form.instance.pk %}
                ویرایش درخواست آزمایش
                {% else %}
                ثبت درخواست آزمایش جدید
                {% endif %}
            </h3>
                </div>
                <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                    <!-- اطلاعات اصلی -->
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">اطلاعات اصلی</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.project.id_for_label }}" class="form-label">پروژه</label>
                                    {% render_field form.project class="form-control select2" %}
                                    {% if form.project.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.project.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.layer.id_for_label }}" class="form-label">لایه</label>
                                    {% render_field form.layer class="form-control select2" %}
                                    {% if form.layer.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.layer.errors }}
                                        </div>
                                    {% endif %}
                        </div>

                                <div class="mb-3">
                                    <label for="{{ form.experiment_type.id_for_label }}" class="form-label">نوع آزمایش</label>
                                    {% render_field form.experiment_type class="form-control select2" multiple="multiple" %}
                                    {% if form.experiment_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.experiment_type.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.experiment_subtype.id_for_label }}" class="form-label">زیرگروه آزمایش</label>
                                    {% render_field form.experiment_subtype class="form-control select2" multiple="multiple" %}
                                    {% if form.experiment_subtype.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.experiment_subtype.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                                </div>
                            </div>
                        </div>

                    <!-- اطلاعات محل و کیلومتراژ -->
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h5 class="card-title mb-0">اطلاعات محل و کیلومتراژ</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.concrete_place.id_for_label }}" class="form-label">محل بتن‌ریزی</label>
                                    {% render_field form.concrete_place class="form-control select2" %}
                                    {% if form.concrete_place.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.concrete_place.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.request_date.id_for_label }}" class="form-label">تاریخ درخواست</label>
                                    {% render_field form.request_date class="form-control" %}
                                    {% if form.request_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.request_date.errors }}
                                        </div>
                                    {% endif %}
                        </div>

                                <div class="mb-3">
                                    <label for="{{ form.start_kilometer.id_for_label }}" class="form-label">کیلومتراژ شروع</label>
                                    {% render_field form.start_kilometer class="form-control" %}
                                    {% if form.start_kilometer.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.start_kilometer.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.end_kilometer.id_for_label }}" class="form-label">کیلومتراژ پایان</label>
                                    {% render_field form.end_kilometer class="form-control" %}
                                    {% if form.end_kilometer.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.end_kilometer.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                                </div>
                            </div>
                        </div>

                    <!-- اطلاعات تکمیلی -->
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0">اطلاعات تکمیلی</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">توضیحات</label>
                                    {% render_field form.description class="form-control" rows="3" %}
                                    {% if form.description.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.description.errors }}
                                        </div>
                                    {% endif %}
                        </div>

                                <div class="mb-3">
                                    <label for="{{ form.target_density.id_for_label }}" class="form-label">حد تراکم</label>
                                    {% render_field form.target_density class="form-control" %}
                                    {% if form.target_density.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.target_density.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.target_strength.id_for_label }}" class="form-label">حد مقاومت فشاری</label>
                                    {% render_field form.target_strength class="form-control" %}
                                    {% if form.target_strength.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.target_strength.errors }}
                                        </div>
                                    {% endif %}
                        </div>

                                <div class="mb-3" id="mix-design-group" style="display:none;">
                                    <label for="id_mix_design" class="form-label">طرح اختلاط</label>
                                    {% render_field form.mix_design class="form-control" %}
                                    {% if form.mix_design.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.mix_design.errors }}
                                        </div>
                                    {% endif %}
                        </div>

                                <div class="mb-3">
                                    <label for="{{ form.request_file.id_for_label }}" class="form-label">فایل درخواست</label>
                                    {% render_field form.request_file class="form-control" %}
                                    {% if form.request_file.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.request_file.errors }}
                                        </div>
                                    {% endif %}
                                    {% if form.instance.request_file %}
                                    <div class="mt-2">
                                        <small class="text-muted">فایل فعلی: {{ form.instance.request_file.name }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>

                <!-- فرم‌ست کیلومتراژ -->
                <div class="card mb-4 shadow kilometer-formset-card">
                    <div class="card-header bg-success text-white d-flex align-items-center justify-content-between">
                        <span><i class="fas fa-ruler-horizontal me-1"></i> بازه‌های کیلومتراژ</span>
                        <button type="button" class="btn btn-light btn-sm fw-bold" id="add-kilometer"><i class="fas fa-plus-circle me-1 text-success"></i>افزودن بازه</button>
                    </div>
                    <div class="card-body pt-3 pb-2" id="kilometer-formset">
                        {{ kilometer_formset.management_form }}
                        {% for form in kilometer_formset %}
                            <div class="row kilometer-form-row align-items-end mb-2 border rounded-3 p-2 position-relative animate__animated animate__fadeIn bg-light">
                                <div class="col-5">
                                    <label class="form-label small">شروع (کیلومتر)</label>
                                    {% render_field form.start_kilometer class="form-control" placeholder="شروع" %}
                                </div>
                                <div class="col-5">
                                    <label class="form-label small">پایان (کیلومتر)</label>
                                    {% render_field form.end_kilometer class="form-control" placeholder="پایان" %}
                                </div>
                                <div class="col-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-danger remove-kilometer w-100"><i class="fas fa-trash"></i></button>
                                </div>
                                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="card-footer bg-white border-0 pt-2 pb-2">
                        <div class="form-text text-muted">مثال: 2.000 تا 2.500</div>
                    </div>
                </div>
                <!-- template مخفی برای افزودن بازه جدید -->
                <template id="kilometer-form-template">
                    <div class="row kilometer-form-row align-items-end mb-2 border rounded-3 p-2 position-relative animate__animated animate__fadeIn bg-light">
                        <div class="col-5">
                            <label class="form-label small">شروع (کیلومتر)</label>
                            <input type="text" name="__prefix__-start_kilometer" class="form-control" placeholder="شروع" />
                        </div>
                        <div class="col-5">
                            <label class="form-label small">پایان (کیلومتر)</label>
                            <input type="text" name="__prefix__-end_kilometer" class="form-control" placeholder="پایان" />
                        </div>
                        <div class="col-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger remove-kilometer w-100"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </template>
                <!-- فرم‌ست فایل‌ها -->
                <div class="card mb-4 shadow file-formset-card">
                    <div class="card-header bg-info text-white d-flex align-items-center justify-content-between">
                        <span><i class="fas fa-paperclip me-1"></i> فایل‌های درخواست</span>
                        <button type="button" class="btn btn-light btn-sm fw-bold" id="add-file"><i class="fas fa-plus-circle me-1 text-info"></i>افزودن فایل</button>
                    </div>
                    <div class="card-body pt-3 pb-2" id="file-formset">
                        {{ file_formset.management_form }}
                        {% for form in file_formset %}
                            <div class="row file-form-row align-items-end mb-2 border rounded-3 p-2 position-relative animate__animated animate__fadeIn bg-light">
                                <div class="col-10">
                                    <label class="form-label small">فایل</label>
                                    {% render_field form.file class="form-control" %}
                                </div>
                                <div class="col-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-danger remove-file w-100"><i class="fas fa-trash"></i></button>
                                </div>
                                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <template id="file-form-template">
                    <div class="row file-form-row align-items-end mb-2 border rounded-3 p-2 position-relative animate__animated animate__fadeIn bg-light">
                        <div class="col-10">
                            <label class="form-label small">فایل</label>
                            <input type="file" name="__prefix__-file" class="form-control" />
                        </div>
                        <div class="col-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger remove-file w-100"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </template>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save me-2"></i>
                        {% if form.instance.pk %}
                        بروزرسانی درخواست
                        {% else %}
                        ثبت درخواست
                        {% endif %}
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="window.history.back();">
                        <i class="fas fa-arrow-right"></i> بازگشت
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.6.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%'
    });

    // Handle project change
    $('#id_project').on('change', function() {
        var projectId = $(this).val();
        var layerSelect = $('#id_layer');
        var selectedLayer = layerSelect.data('selected');
        console.log('Project changed:', projectId); // log selected project
        if (projectId) {
            $.ajax({
                url: "{% url 'experiment:get_layers' %}",
                data: {
                    'project_id': projectId
                },
                dataType: 'json',
                success: function(data) {
                    console.log('Layers AJAX response:', data); // log response
                    layerSelect.empty();
                    layerSelect.append($('<option></option>').attr('value', '').text('انتخاب کنید'));
                    $.each(data.layers, function(index, item) {
                        var option = $('<option></option>')
                            .attr('value', item.id)
                            .text(item.name);
                        if (selectedLayer && selectedLayer == item.id) {
                            option.attr('selected', 'selected');
                        }
                        layerSelect.append(option);
                    });
                    layerSelect.trigger('change');
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching layers:', error);
                    console.log('AJAX error response:', xhr.responseText); // log error response
                    layerSelect.empty();
                    layerSelect.append($('<option></option>').attr('value', '').text('خطا در دریافت لایه‌ها'));
                }
            });
        } else {
            layerSelect.empty();
            layerSelect.append($('<option></option>').attr('value', '').text('انتخاب کنید'));
            layerSelect.trigger('change');
        }
    });

    // Handle experiment type change
    $('#id_experiment_type').on('change', function() {
        var experimentTypeIds = $(this).val(); // آرایه از مقادیر انتخاب شده
        var subtypeSelect = $('#id_experiment_subtype');
        if (experimentTypeIds && experimentTypeIds.length > 0) {
            $.ajax({
                url: "{% url 'experiment:get_subtypes' %}",
                traditional: true,
                data: {
                    'experiment_type_id': experimentTypeIds
                },
                dataType: 'json',
                success: function(data) {
                    subtypeSelect.empty();
                    $.each(data.subtypes, function(index, item) {
                        subtypeSelect.append(
                            $('<option></option>')
                                .attr('value', item.id)
                                .text(item.name)
                        );
                    });
                    subtypeSelect.trigger('change');
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching subtypes:', error);
                    subtypeSelect.empty();
                    subtypeSelect.append($('<option></option>').attr('value', '').text('خطا در دریافت زیرگروه‌ها'));
                }
            });
        } else {
            subtypeSelect.empty();
            subtypeSelect.trigger('change');
        }
    });

    // نمایش داینامیک طرح اختلاط
    function toggleMixDesignField() {
        var selectedTypes = $('#id_experiment_type').select2('data').map(function(item){ return item.text; });
        if (selectedTypes.some(function(name){ return name.includes('آسفالت'); })) {
            $('#mix-design-group').show();
        } else {
            $('#mix-design-group').hide();
            $('#id_mix_design').val('');
        }
    }
    $('#id_experiment_type').on('change', toggleMixDesignField);
    toggleMixDesignField();

    // Trigger change events if values are pre-selected
    if ($('#id_project').val()) {
        $('#id_project').trigger('change');
    }
    if ($('#id_experiment_type').val()) {
        $('#id_experiment_type').trigger('change');
    }

    // کیلومتراژ
    function updateKilometerFormsetIndexes() {
        let forms = $('#kilometer-formset .kilometer-form-row');
        $('#id_kilometer-TOTAL_FORMS').val(forms.length);
        forms.each(function(i) {
            $(this).find('input, select').each(function() {
                let name = $(this).attr('name');
                if (name) {
                    let newName = name.replace(/kilometer-\d+-/, 'kilometer-' + i + '-');
                    $(this).attr('name', newName);
                    $(this).attr('id', 'id_' + newName);
                }
            });
        });
    }
    $('#add-kilometer').click(function() {
        let total = $('#kilometer-formset .kilometer-form-row').length;
        let template = $('#kilometer-form-template').html().replace(/__prefix__/g, 'kilometer-' + total);
        $('#kilometer-formset').append(template);
        updateKilometerFormsetIndexes();
    });
    $('#kilometer-formset').on('click', '.remove-kilometer', function() {
        $(this).closest('.kilometer-form-row').remove();
        updateKilometerFormsetIndexes();
    });

    // فایل
    function updateFileFormsetIndexes() {
        let forms = $('#file-formset .file-form-row');
        $('#id_file-TOTAL_FORMS').val(forms.length);
        forms.each(function(i) {
            $(this).find('input, select').each(function() {
                let name = $(this).attr('name');
                if (name) {
                    let newName = name.replace(/file-\d+-/, 'file-' + i + '-');
                    $(this).attr('name', newName);
                    $(this).attr('id', 'id_' + newName);
                }
            });
        });
    }
    $('#add-file').click(function() {
        let total = $('#file-formset .file-form-row').length;
        let template = $('#file-form-template').html().replace(/__prefix__/g, 'file-' + total);
        $('#file-formset').append(template);
        updateFileFormsetIndexes();
    });
    $('#file-formset').on('click', '.remove-file', function() {
        $(this).closest('.file-form-row').remove();
        updateFileFormsetIndexes();
    });
});
</script>
{% endblock %}
{% endblock %}